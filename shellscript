#!/usr/bin/env bash
set -euo pipefail

src="/var/www/html"
dest="/backup/html_$(date +%F_%H-%M-%S).tar.gz"

# 1. Ensure $src exists
if [ ! -d "$src" ]; then
    echo "📂 Creating $src..."
    sudo mkdir -p "$src"
    sudo chown -R $USER:$USER "$src"   # Optional
fi

# 2. Ensure /backup exists
if [ ! -d "$(dirname "$dest")" ]; then
    echo "📂 Creating $(dirname "$dest")..."
    sudo mkdir -p "$(dirname "$dest")"
fi

# 3. Create backup using src variable, avoid leading '/' in tar
echo "📦 Creating backup..."
if sudo tar -czf "$dest" -C "$(dirname "$src")" "$(basename "$src")"; then
    echo "✅ Backup saved to $dest"
else
    echo "❌ Backup failed!"
    exit 1
fi
